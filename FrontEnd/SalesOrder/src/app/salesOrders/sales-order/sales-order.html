<main>
    <div class="order-card">
        <form [formGroup]="form" (ngSubmit)="onSalesOrderSubmit()" id="salesOrderForm">
            <h4 class="mb-3 text-primary">Order Information</h4>
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <label class="form-label">Order No<span class="required">*</span></label>
                    <input type="text" class="form-control" name="orderNo" placeholder="SO-XXXX" OrderNumberUniqueness
                        (duplicateCheck)="hasOrderNo($event)" formControlName="orderNo" />
                    @if(hasOrderNoExists) {<p class="inputErrorMessage">This order no already exists</p>}
                </div>
                <div class="col-md-4">
                    <label class="form-label">Order Date<span class="required">*</span></label>
                    <input type="date" class="form-control" name="orderDate" formControlName="orderDate" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Customer<span class="required">*</span></label>
                    <label class="customerType">
                        <label for="existing"><input id="existing" type="radio" name="customerType"
                                formControlName="customerType" value="existing"
                                (change)="onSeletedCustomerType($event)"> Existing</label>
                        <label for="new"><input id="new" type="radio" name="customerType" formControlName="customerType"
                                value="new" (change)="onSeletedCustomerType($event)"> New</label>
                        <label for="guest"><input id="guest" type="radio" name="customerType"
                                formControlName="customerType" value="guest" (change)="onSeletedCustomerType($event)">
                            Guest</label>
                    </label>
                    @if(form.value.customerType == "existing")
                    {
                    <select class="form-control" formControlName="customerExist" (change)="onSelectedCustomer()">
                        <option [value]="null" disabled selected>Select a customer</option>
                        @for (item of salesOrderService.customers(); track $index)
                        {
                           <option [value]="item.Id">{{item.Name}}</option>
                        }
                    </select>
                    }
                    @if(form.value.customerType == "new")
                    {
                    <input type="text" class="form-control" name="customerId" placeholder="Enter customer name"
                        formControlName="customerNew" (input)="onCustomerName()"/>
                    }
                    @if(form.value.customerType == "guest")
                    {
                    <input type="text" class="form-control" name="customerId" placeholder="No customer name needed"
                        disabled=true />
                    }
                    @if(!isCustomerSelected)
                    {
                        <p class="inputErrorMessage">Customeer is required</p>
                    }
                    @if(!hasCustomerName)
                    {
                        <p class="inputErrorMessage">Customer name is required</p>
                    }
                </div>
                <div class="col-md-4">
                    <label class="form-label">Order Status</label>
                    <select class="form-select" name="orderStatus" formControlName="orderStatus" (change)="onOrderStatusSelected()">
                        <option [value]="null" selected disabled>Select status</option>
                        <option [value]="1">Pending</option>
                        <option [value]="2">Processing</option>
                        <option [value]="3">Shipped</option>
                        <option [value]="4">Completed</option>
                        <option [value]="5">Cancelled</option>
                    </select>
                    @if(!isOrderStatusSelected)
                    {
                        <p class="inputErrorMessage">Order status required</p>
                    }
                </div>
                <div class="col-md-4">
                    <label class="form-label">VAT (%)</label>
                    <input type="number" class="form-control" name="vat" formControlName="vat" (change)="onVatChange()" min="0"/>
                    @if(vatError) {<p class="inputErrorMessage">VAT Can not be less than Zero</p>}
                </div>
                <div class="col-md-4">
                    <label class="form-label">Discount (%)</label>
                    <input type="number" class="form-control" name="discount" canNotLessThanZero
                        (islessthanZero)="hasDiscountError($event)" formControlName="discount" (change)="onDiscountChange()" min="0"  />
                    @if(discountError) {<p class="inputErrorMessage">Discount Can not be less than Zero</p>}
                </div>
            </div>

            <h5 class="mb-3 text-secondary">Order Items</h5>
            <div class="table-responsive mb-3">
                <table class="table table-bordered align-middle" id="itemsTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Unit Price ($)</th>
                            <th>Subtotal ($)</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody formArrayName="orderItems">
                        @for (item of orderItems.controls; track item; let i = $index)
                        {
                        <tr [formGroupName]="i">
                            <td>{{ i + 1 }}</td>
                            <td>
                                <select class="form-control" (change)="SelectedProdut(i,$event)" formControlName="productId">
                                    <option [value]="null" disabled selected>Select a product</option>
                                    @for (product of salesOrderService.products(); track $index)
                                    {
                                        <option [value]="product.Id">{{product.Name}}</option>
                                    }
                                </select>
                            </td>
                            <td><input type="number" class="form-control" formControlName="quantity"
                                    (input)="calcSubtotal(i)" canNotLessThanZero (islessthanZero)="hasQuantityError($event)" min="1">
                                @if(quantityError) {<p class="inputErrorMessage">Quantity can not be less than One</p>}</td>
                            <td><input type="number" class="form-control" formControlName="unitPrice"
                                    [disabled]="true"></td>
                            <td><input type="text" class="form-control" formControlName="subtotal" readonly></td>
                            <td><button type="button" class="btn btn-danger btn-sm" (click)="removeItem(i)">Ã—</button>
                            </td>
                        </tr>
                        }                         
                    </tbody>
                    @if(duplicateProductSelected()) {<p class="inputErrorMessage">Selected item already exists</p>}
                </table>
            </div>

            <button type="button" class="btn btn-add mb-3" id="addRowBtn" (click)="addItem()">+ Add Item</button>

            <div class="d-flex justify-content-end mb-4">
                <div class="w-25">
                    <label class="form-label fw-bold">Total Amount ($)</label>
                    <input type="text" class="form-control text-end" id="totalAmount" formControlName="totalAmount">
                </div>
            </div>

            <div class="text-end">
                 @if(form.value.id)
                 {
                    <button type="button" class="btn btn-danger update px-4" (click)="canCelUpdate()">Cancel</button>
                    <button type="submit" class="btn btn-success px-4">Update</button>
                 }
                 @else
                 {
                     <button type="submit" class="btn btn-primary px-4">Create</button>
                 }
            </div>
        </form>
        @if(noProductErrorMessage) {<p class="inputErrorMessage">No product is selected</p>}
    </div>
</main>